services:
  # Base de datos persistente (compartida entre versiones)
  db:
    image: postgres:15-alpine
    container_name: hotel_casino_db
    environment:
      POSTGRES_HOST: ${DB_HOST:-db}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-casino123}
      POSTGRES_USER: ${DB_USER:-hoteluser}
      POSTGRES_DB: ${DB_DATABASE:-hotel_casino}
      POSTGRES_PORT: ${DB_PORT:-5432}
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./backend/database/scripts/:/docker-entrypoint-initdb.d/
    ports:
      - "5432:5432"
    networks:
      - hotel-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${DB_USER:-hoteluser} -d ${DB_DATABASE:-hotel_casino}",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Backend Version 1 - Versión estable
  backend_v1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hotel_api_v1
    ports:
      - "3000:3000" # Puerto principal para v1
    volumes:
      - ./backend:/usr/src/app
      - /usr/src/app/node_modules
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - APP_VERSION=1.0.0
      - BOOKING_MODE=${BOOKING_MODE:-pg}
      - PGUSER=${DB_USER:-hoteluser}
      - PGPASSWORD=${DB_PASSWORD:-casino123}
      - PGDATABASE=${DB_DATABASE:-hotel_casino}
      - PGHOST=${DB_HOST:-db}
      - PGPORT=${DB_PORT:-5432}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - hotel-network
    restart: unless-stopped
    command: sh -c "npm install && npm start"

  # Backend Version 2 - Nueva versión
  backend_v2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hotel_api_v2
    ports:
      - "3001:3000" # Puerto alternativo para v2
    volumes:
      - ./backend:/usr/src/app
      - /usr/src/app/node_modules
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - APP_VERSION=2.0.0
      - BOOKING_MODE=pg
      - PGUSER=${DB_USER:-hoteluser}
      - PGPASSWORD=${DB_PASSWORD:-casino123}
      - PGDATABASE=${DB_DATABASE:-hotel_casino}
      - PGHOST=${DB_HOST:-db}
      - PGPORT=${DB_PORT:-5432}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - hotel-network
    restart: unless-stopped
    command: sh -c "npm install && npm start"
    profiles:
      - v2 # Solo se levanta cuando se especifica el profile v2

  # Load Balancer / Proxy (nginx para demostrar switcheo)
  nginx:
    image: nginx:alpine
    container_name: hotel_nginx
    ports:
      - "8080:80" # Puerto principal de la API (nginx)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend_v1
    networks:
      - hotel-network
    restart: unless-stopped

volumes:
  db_data:
    driver: local

networks:
  hotel-network:
    driver: bridge
